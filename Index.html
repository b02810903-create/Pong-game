<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Pong Pro</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
:root{--cyan:#00e5ff;--red:#ff1744;--bg:#04040e;--card:rgba(255,255,255,.04);--border:rgba(255,255,255,.07);--purple:#7c4dff}
body{background:var(--bg);display:flex;justify-content:center;align-items:flex-start;min-height:100vh;min-height:100dvh;font-family:'Segoe UI',system-ui,sans-serif;overflow:hidden;touch-action:none;color:#fff;padding-bottom:env(safe-area-inset-bottom,0)}
.app{width:100%;max-width:440px;height:100vh;height:100dvh;display:flex;flex-direction:column;position:relative;overflow:hidden}
.screen{position:absolute;inset:0;display:flex;flex-direction:column;transition:opacity .3s,transform .3s;z-index:1;overflow-y:auto;overflow-x:hidden}
.screen.hide{opacity:0;pointer-events:none;transform:translateY(20px)}
.screen.active{opacity:1;pointer-events:auto;transform:translateY(0)}
#nickScreen{justify-content:center;align-items:center;padding:30px;z-index:100;background:var(--bg)}
.n-logo{font-size:64px;margin-bottom:10px;filter:drop-shadow(0 0 20px rgba(0,229,255,.4))}
.n-title{font-size:32px;font-weight:900;background:linear-gradient(135deg,var(--cyan),#00b0ff,var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:6px}
.n-sub{color:#555;font-size:11px;text-transform:uppercase;letter-spacing:3px;margin-bottom:30px}
.n-input{width:100%;max-width:280px;padding:14px 20px;font-size:16px;font-weight:600;color:#fff;background:rgba(255,255,255,.06);border:2px solid rgba(0,229,255,.15);border-radius:14px;outline:none;text-align:center;margin-bottom:16px}
.n-input:focus{border-color:var(--cyan);box-shadow:0 0 20px rgba(0,229,255,.15)}
.n-input::placeholder{color:#444}
#menuScreen{padding:20px;padding-top:50px;align-items:center;background:var(--bg)}
.m-header{text-align:center;margin-bottom:24px}
.m-logo{font-size:48px;margin-bottom:4px;filter:drop-shadow(0 0 15px rgba(0,229,255,.3))}
.m-title{font-size:34px;font-weight:900;background:linear-gradient(135deg,var(--cyan),#00b0ff,var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.m-nick{color:#555;font-size:12px;margin-top:6px}.m-nick b{color:var(--cyan)}
.m-rank{color:#888;font-size:11px;margin-top:2px}.m-rank b{color:#ffd600}
.m-cards{width:100%;display:flex;flex-direction:column;gap:10px}
.mc{width:100%;padding:18px 20px;background:linear-gradient(135deg,rgba(0,229,255,.03),rgba(124,77,255,.03));border:1px solid rgba(0,229,255,.1);border-radius:16px;cursor:pointer;display:flex;align-items:center;gap:14px;transition:all .15s}
.mc:active{transform:scale(.97);background:rgba(0,229,255,.08)}
.mc-ico{font-size:28px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:rgba(0,229,255,.06);border-radius:12px;flex-shrink:0}
.mc-txt h3{font-size:15px;font-weight:700;margin-bottom:2px}.mc-txt p{font-size:11px;color:#555}
.m-bottom{margin-top:auto;display:flex;gap:10px;width:100%;padding:20px 0}
.m-bb{flex:1;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:14px;text-align:center;cursor:pointer;font-size:12px;color:#888;font-weight:600}
.m-bb:active{background:rgba(0,229,255,.08);color:var(--cyan)}
#botMenu,#ptsMenu,#twoMenu,#lbScreen,#settingsScreen,#adminScreen,#onlineMenu,#lobbyCreate,#lobbyJoin,#matchmaking{padding:20px;padding-top:30px;align-items:center;background:var(--bg)}
.back{align-self:flex-start;padding:10px 16px;font-size:13px;color:#888;cursor:pointer;margin-bottom:20px;border-radius:10px}
.back:active{color:var(--cyan)}
.st{font-size:22px;font-weight:800;margin-bottom:6px;text-align:center}
.sd{color:#555;font-size:12px;margin-bottom:24px;text-align:center}
.diff-r{display:flex;gap:8px;width:100%;margin-bottom:16px}
.db{flex:1;padding:12px;font-size:11px;font-weight:700;color:#555;background:var(--card);border:1px solid var(--border);border-radius:12px;cursor:pointer;text-align:center;text-transform:uppercase;transition:all .15s}
.db.on{color:var(--cyan);background:rgba(0,229,255,.1);border-color:rgba(0,229,255,.3);box-shadow:0 0 12px rgba(0,229,255,.1)}
.db:active{transform:scale(.95)}
.mcard{width:100%;padding:16px;background:var(--card);border:1px solid var(--border);border-radius:14px;cursor:pointer;margin-bottom:10px;text-align:center;transition:all .15s}
.mcard:active{transform:scale(.97);background:rgba(0,229,255,.06)}
.mcard h3{font-size:15px;margin-bottom:3px}.mcard p{font-size:11px;color:#555}
.pg{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;margin-bottom:16px}
.pb{padding:20px;font-size:22px;font-weight:800;background:var(--card);border:1px solid var(--border);border-radius:14px;cursor:pointer;text-align:center;color:#fff;transition:all .15s}
.pb:active{transform:scale(.95);border-color:var(--cyan);color:var(--cyan)}
.lb-stats{display:flex;gap:8px;width:100%;margin-bottom:16px}
.lb-stat{flex:1;padding:10px;background:var(--card);border:1px solid var(--border);border-radius:10px;text-align:center}
.lb-stat .lsv{font-size:20px;font-weight:900;color:var(--cyan)}.lb-stat .lsl{font-size:9px;color:#555;text-transform:uppercase;letter-spacing:1px;margin-top:2px}
.lb-tabs{display:flex;gap:6px;width:100%;margin-bottom:16px}
.lb-tab{flex:1;padding:10px;font-size:11px;font-weight:700;color:#555;background:var(--card);border:1px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;text-transform:uppercase}
.lb-tab.on{color:var(--cyan);background:rgba(0,229,255,.1);border-color:rgba(0,229,255,.3)}
.lb-list{width:100%;overflow-y:auto;max-height:60vh;-webkit-overflow-scrolling:touch}
.lb-item{display:flex;align-items:center;padding:12px 14px;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:6px}
.lb-item.me{border-color:rgba(0,229,255,.3);background:rgba(0,229,255,.06)}
.lb-rank{width:30px;font-size:16px;font-weight:900;color:#555;flex-shrink:0}
.lb-rank.g{color:#ffd600}.lb-rank.s{color:#ccc}.lb-rank.b{color:#ff8a65}
.lb-info{flex:1;min-width:0}.lb-name{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.lb-sub{font-size:10px;color:#555;margin-top:1px}
.lb-right{text-align:right;flex-shrink:0}.lb-pts{font-size:16px;font-weight:900;color:var(--cyan)}
.lb-empty{text-align:center;color:#444;padding:40px;font-size:13px}
.lb-me-card{width:100%;padding:12px 16px;background:rgba(0,229,255,.06);border:1px solid rgba(0,229,255,.2);border-radius:12px;margin-bottom:16px;display:flex;align-items:center;gap:12px}
.lb-me-rank{font-size:24px;font-weight:900;color:var(--cyan)}.lb-me-rank span{font-size:10px;color:#555;display:block}
.lb-me-info{flex:1}.lb-me-name{font-size:14px;font-weight:700}.lb-me-stats{font-size:11px;color:#888;margin-top:2px}
.conn-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.conn-on{background:#4caf50;box-shadow:0 0 8px #4caf50}.conn-off{background:#f44336}
.lobby-code{font-size:42px;font-weight:900;letter-spacing:8px;color:var(--cyan);margin:20px 0;text-shadow:0 0 30px rgba(0,229,255,.3)}
.lobby-status{color:#555;font-size:13px;margin-bottom:16px}
.lobby-dots{display:flex;gap:6px;margin-bottom:16px}
.lobby-dots span{width:8px;height:8px;border-radius:50%;background:var(--cyan);animation:ldot 1.4s infinite}
.lobby-dots span:nth-child(2){animation-delay:.2s}.lobby-dots span:nth-child(3){animation-delay:.4s}
@keyframes ldot{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1.2)}}
.join-input{width:100%;max-width:260px;padding:14px;font-size:20px;font-weight:800;color:#fff;background:rgba(255,255,255,.06);border:2px solid var(--border);border-radius:14px;outline:none;text-align:center;letter-spacing:6px;text-transform:uppercase;margin-bottom:16px}
.join-input:focus{border-color:var(--cyan)}
.join-input::placeholder{color:#333;letter-spacing:2px;font-size:14px}
.err-msg{color:var(--red);font-size:12px;margin-bottom:10px;min-height:16px}
.set-sec{margin-bottom:20px}.set-sec-t{font-size:11px;color:#555;text-transform:uppercase;letter-spacing:2px;margin-bottom:10px}
.set-row{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:8px}
.set-l{font-size:13px;color:#ccc}
.s-toggle{width:44px;height:24px;border-radius:12px;background:rgba(255,255,255,.12);position:relative;cursor:pointer;transition:background .2s;flex-shrink:0}
.s-toggle.on{background:rgba(0,229,255,.35)}
.s-toggle::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;transition:transform .2s}
.s-toggle.on::after{transform:translateX(20px)}
.sl{-webkit-appearance:none;width:100px;height:4px;border-radius:2px;background:rgba(255,255,255,.15);outline:none}
.sl::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--cyan);cursor:pointer;border:2px solid var(--bg)}
.danger-btn{width:100%;padding:14px;font-size:13px;font-weight:700;color:var(--red);background:rgba(255,23,68,.08);border:1px solid rgba(255,23,68,.2);border-radius:12px;cursor:pointer;text-align:center;margin-top:10px}
.admin-t{color:var(--red);font-size:20px;font-weight:900;margin-bottom:20px}
.admin-card{padding:14px 16px;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:8px}
.admin-card h4{font-size:13px;color:var(--cyan);margin-bottom:4px}.admin-card p{font-size:11px;color:#888}
.admin-in{width:100%;padding:10px 14px;font-size:13px;color:#fff;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:8px;outline:none;margin-top:6px}
.admin-btn{padding:8px 16px;font-size:11px;font-weight:700;color:#fff;background:var(--red);border:none;border-radius:8px;cursor:pointer;margin-top:8px}
#gameScreen{background:var(--bg);z-index:5}
.g-top{display:flex;justify-content:space-between;align-items:center;padding:6px 12px;flex-shrink:0}
.scores{display:flex;align-items:center;gap:16px;flex:1;justify-content:center}
.sc{text-align:center}.sc .lb{color:#555;font-size:9px;text-transform:uppercase;letter-spacing:2px}.sc .val{font-size:30px;font-weight:900}
.c1{color:var(--cyan)}.c2{color:var(--red)}
.s-sep{color:#333;font-size:22px}
.gg{width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.06);border:1px solid var(--border);display:flex;justify-content:center;align-items:center;cursor:pointer;font-size:18px;color:#666;flex-shrink:0}
.gg:active{color:var(--cyan)}
.g-mid{flex:1;position:relative;margin:0 8px 4px;min-height:0}
canvas{width:100%;height:100%;border-radius:14px;display:block}
.ctrls{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:4px 8px;flex-shrink:0;padding-bottom:max(10px,env(safe-area-inset-bottom,10px))}
.cb{padding:18px;font-size:24px;background:linear-gradient(180deg,rgba(0,229,255,.06),rgba(0,229,255,.02));border:1px solid rgba(0,229,255,.15);border-radius:16px;color:#fff;text-align:center;cursor:pointer;display:flex;justify-content:center;align-items:center;transition:all .08s}
.cb:active{background:rgba(0,229,255,.15);transform:scale(.96)}
.p2b{background:linear-gradient(180deg,rgba(255,23,68,.06),rgba(255,23,68,.02));border-color:rgba(255,23,68,.15)}
.p2b:active{background:rgba(255,23,68,.15)}
.p2top{padding:4px 8px;flex-shrink:0}
.cd-ov{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;background:rgba(4,4,14,.88);border-radius:14px;z-index:20;transition:opacity .2s}
.cd-ov.hide{opacity:0;pointer-events:none}
.cd-n{font-size:80px;font-weight:900;color:var(--cyan);text-shadow:0 0 60px rgba(0,229,255,.5);animation:cdp .5s ease}
@keyframes cdp{0%{transform:scale(1.5);opacity:0}100%{transform:scale(1);opacity:1}}
.p-ov{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;background:rgba(4,4,14,.94);border-radius:14px;z-index:25;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);transition:opacity .2s}
.p-ov.hide{opacity:0;pointer-events:none}
.p-title{font-size:28px;font-weight:900;margin-bottom:20px;color:var(--cyan)}
.p-btn{width:200px;padding:14px;font-size:14px;font-weight:700;border:none;border-radius:14px;cursor:pointer;margin-bottom:10px;text-align:center;color:#fff;transition:all .15s}
.p-btn:active{transform:scale(.95)}
.p-resume{background:linear-gradient(135deg,var(--cyan),#0091ea)}
.p-quit{background:rgba(255,255,255,.08)}
.p-sr{display:flex;justify-content:space-between;align-items:center;width:200px;margin-bottom:12px}
.p-sl{color:#aaa;font-size:12px}
.go-ov{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;background:rgba(4,4,14,.94);border-radius:14px;z-index:25;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);transition:opacity .3s}
.go-ov.hide{opacity:0;pointer-events:none}
.go-e{font-size:56px;margin-bottom:8px}.go-t{font-size:30px;font-weight:900;margin-bottom:6px}
.go-s{font-size:24px;margin-bottom:10px;color:#aaa}.go-s b{font-size:30px}
.go-rank{color:#888;font-size:13px;margin-bottom:20px}.go-rank b{color:#ffd600}
.go-btns{display:flex;flex-direction:column;gap:10px}
.go-b{width:220px;padding:14px;font-size:14px;font-weight:700;border:none;border-radius:14px;cursor:pointer;text-align:center;color:#fff;transition:all .15s}
.go-b:active{transform:scale(.95)}
.go-re{background:linear-gradient(135deg,var(--cyan),#0091ea)}
.go-mn{background:rgba(255,255,255,.08)}
.btn{padding:14px 40px;font-size:14px;font-weight:700;color:#fff;background:linear-gradient(135deg,var(--cyan),#0091ea);border:none;border-radius:40px;cursor:pointer;letter-spacing:1px;text-transform:uppercase;box-shadow:0 4px 25px rgba(0,229,255,.25);transition:all .15s}
.btn:active{transform:scale(.93)}
.mode-info{color:#444;font-size:11px;text-align:center;margin-top:6px;font-style:italic}
.cancel-btn{padding:12px 30px;font-size:13px;color:#888;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:12px;cursor:pointer;margin-top:16px}
.cancel-btn:active{color:var(--red)}
.mm-spinner{width:50px;height:50px;border:3px solid rgba(0,229,255,.2);border-top-color:var(--cyan);border-radius:50%;animation:spin 1s linear infinite;margin:20px 0}
@keyframes spin{to{transform:rotate(360deg)}}
.mm-count{color:#888;font-size:12px;margin-top:10px}
.ping-disp { font-size: 10px; color: #666; margin-right: 8px; font-family: monospace; font-weight: bold; }
</style>
</head>
<body>
<div class="app">
<div class="screen active" id="nickScreen">
<div class="n-logo">&#127955;</div><div class="n-title">PONG PRO</div><div class="n-sub">Введи никнейм</div>
<input class="n-input" id="nickIn" placeholder="Твой ник..." maxlength="16" autocomplete="off">
<button class="btn" id="nickBtn">Войти</button></div>
<div class="screen hide" id="menuScreen">
<div class="m-header"><div class="m-logo">&#127955;</div><div class="m-title">PONG PRO</div>
<div class="m-nick">Привет, <b id="menuNick">Player</b></div><div class="m-rank" id="menuRank"></div></div>
<div class="m-cards">
<div class="mc" id="mcBot"><div class="mc-ico">&#129302;</div><div class="mc-txt"><h3>Против бота</h3><p>ИИ разной сложности</p></div></div>
<div class="mc" id="mcTwo"><div class="mc-ico">&#128101;</div><div class="mc-txt"><h3>На двоих</h3><p>На одном устройстве</p></div></div>
<div class="mc" id="mcOnline"><div class="mc-ico">&#127760;</div><div class="mc-txt"><h3>Онлайн</h3><p>По сети с другом</p></div></div>
<div class="mc" id="mcLb"><div class="mc-ico">&#127942;</div><div class="mc-txt"><h3>Лидеры</h3><p>Общий топ</p></div></div></div>
<div class="m-bottom"><div class="m-bb" id="mcSet">Настройки</div><div class="m-bb" id="mcAdm" style="display:none">Админ</div></div></div>
<div class="screen hide" id="botMenu"><div class="back" data-to="menuScreen">&#8592; Назад</div><div class="st">Против бота</div><div class="sd">Сложность и режим</div><div class="diff-r" id="diffRow"><div class="db" data-v="easy">Лёгкий</div><div class="db on" data-v="medium">Средний</div><div class="db" data-v="hard">Сложный</div></div><div class="mcard" id="mInf"><h3>Бесконечный</h3><p>Без ограничений</p></div><div class="mcard" id="mPts"><h3>На очки</h3><p>Первый до N</p></div></div>
<div class="screen hide" id="ptsMenu"><div class="back" data-to="botMenu">&#8592; Назад</div><div class="st">До скольки?</div><div class="sd">Очки для победы</div><div class="pg"><div class="pb" data-p="10">10</div><div class="pb" data-p="15">15</div><div class="pb" data-p="20">20</div><div class="pb" data-p="35">35</div></div></div>
<div class="screen hide" id="twoMenu"><div class="back" data-to="menuScreen">&#8592; Назад</div><div class="st">На двоих</div><div class="sd">Очки для победы</div><div class="pg" id="twoPg"><div class="pb" data-p="10">10</div><div class="pb" data-p="15">15</div><div class="pb" data-p="20">20</div><div class="pb" data-p="35">35</div></div><div class="mode-info">P2 управляет кнопками сверху</div></div>
<div class="screen hide" id="onlineMenu"><div class="back" data-to="menuScreen">&#8592; Назад</div><div class="st">Онлайн</div><div class="sd"><span class="conn-dot" id="connDot"></span><span id="connTxt">Подключение...</span></div><div class="mcard" id="olCreate"><h3>Создать лобби</h3><p>Получи код для друга</p></div><div class="mcard" id="olJoin"><h3>Войти по коду</h3><p>Введи код друга</p></div><div class="mcard" id="olMatch"><h3>Случайный подбор</h3><p>Найти соперника</p></div></div>
<div class="screen hide" id="lobbyCreate"><div class="back" id="lobbyCancel1">&#8592; Отмена</div><div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center"><div class="st">Твой код:</div><div class="lobby-code" id="lobbyCodeTxt">-----</div><div class="lobby-status">Отправь другу</div><div class="lobby-dots"><span></span><span></span><span></span></div><div class="lobby-status">Ожидание...</div></div></div>
<div class="screen hide" id="lobbyJoin"><div class="back" id="lobbyCancel2">&#8592; Отмена</div><div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center"><div class="st">Введи код</div><div class="sd">5 символов от друга</div><div class="err-msg" id="joinErr"></div><input class="join-input" id="joinIn" placeholder="XXXXX" maxlength="5" autocomplete="off"><button class="btn" id="joinBtn">Войти</button></div></div>
<div class="screen hide" id="matchmaking"><div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center"><div class="st">Поиск соперника</div><div class="mm-spinner"></div><div class="sd" id="mmStatus">Ищем игрока...</div><div class="mm-count" id="mmCount"></div><div class="cancel-btn" id="mmCancel">Отмена</div></div></div>
<div class="screen hide" id="lbScreen"><div class="back" data-to="menuScreen">&#8592; Назад</div><div class="st">Общий топ</div><div class="sd">Все игроки</div><div class="lb-stats" id="lbStats"></div><div class="lb-me-card" id="lbMe" style="display:none"></div><div class="lb-tabs"><div class="lb-tab on" data-sort="totalPts">По очкам</div><div class="lb-tab" data-sort="bestGame">Лучшая</div><div class="lb-tab" data-sort="games">Игры</div></div><div class="lb-list" id="lbList"><div class="lb-empty">Загрузка...</div></div></div>
<div class="screen hide" id="settingsScreen"><div class="back" data-to="menuScreen">&#8592; Назад</div><div class="st">Настройки</div><div class="set-sec"><div class="set-sec-t">Звук</div><div class="set-row"><span class="set-l">Музыка</span><input type="range" class="sl" id="sMusVol" min="0" max="100" value="40"></div><div class="set-row"><span class="set-l">Звуки</span><input type="range" class="sl" id="sSfxVol" min="0" max="100" value="60"></div></div><div class="set-sec"><div class="set-sec-t">Геймплей</div><div class="set-row"><span class="set-l">Частицы</span><div class="s-toggle on" id="sPartT"></div></div><div class="set-row"><span class="set-l">Вибрация</span><div class="s-toggle on" id="sVibT"></div></div></div><div class="set-sec"><div class="set-sec-t">Данные</div><div class="danger-btn" id="sReset">Сбросить данные</div></div></div>
<div class="screen hide" id="adminScreen"><div class="back" data-to="menuScreen">&#8592; Назад</div><div class="admin-t">Админ</div><div class="admin-card"><h4>Статистика</h4><p id="admStats">...</p></div><div class="admin-card"><h4>Очистить топ</h4><button class="admin-btn" id="admClearLb">Очистить</button></div><div class="admin-card"><h4>Удалить игрока</h4><input class="admin-in" id="admDelName" placeholder="Ник"><button class="admin-btn" id="admDelBtn">Удалить</button></div><div class="admin-card"><h4>Добавить очки</h4><input class="admin-in" id="admAddName" placeholder="Ник"><input class="admin-in" id="admAddPts" placeholder="Очки" type="number" style="margin-top:4px"><button class="admin-btn" id="admAddBtn" style="background:var(--cyan)">Добавить</button></div><div class="admin-card"><h4>Пароль</h4><input class="admin-in" id="admNewPass" placeholder="Новый"><button class="admin-btn" id="admPassBtn">Сменить</button></div></div>
<div class="screen hide" id="gameScreen">
<div class="p2top" id="p2top" style="display:none"><div class="ctrls"><div class="cb p2b" id="p2l">&#9664; P2</div><div class="cb p2b" id="p2r">P2 &#9654;</div></div></div>
<div class="g-top"><div style="width:38px"></div><div class="scores"><div class="sc"><div class="lb" id="lb1">Игрок</div><div class="val c1" id="s1">0</div></div><div class="s-sep">:</div><div class="sc"><div class="lb" id="lb2">Бот</div><div class="val c2" id="s2">0</div></div></div><div class="ping-disp" id="pingDisp" style="display:none">PING: 0</div><div class="gg" id="gGear">&#9881;</div></div>
<div class="g-mid" id="gMid"><canvas id="c"></canvas>
<div class="cd-ov hide" id="cdOv"><div class="cd-n" id="cdN">3</div></div>
<div class="p-ov hide" id="pOv"><div class="p-title">Пауза</div><div class="p-sr"><span class="p-sl">Музыка</span><input type="range" class="sl" id="pMus" min="0" max="100" value="40"></div><div class="p-sr"><span class="p-sl">Звуки</span><input type="range" class="sl" id="pSfx" min="0" max="100" value="60"></div><button class="p-btn p-resume" id="pResume">Продолжить</button><button class="p-btn p-quit" id="pQuit">В меню</button></div>
<div class="go-ov hide" id="goOv"><div class="go-e" id="goE">&#127942;</div><div class="go-t" id="goT">Победа!</div><div class="go-s"><b class="c1" id="goS1">0</b> - <b class="c2" id="goS2">0</b></div><div class="go-rank" id="goRank"></div><div class="go-btns"><button class="go-b go-re" id="goRe">Заново</button><button class="go-b go-mn" id="goMn">В меню</button></div></div></div>
<div class="ctrls" id="p1ctrls"><div class="cb" id="p1l">&#9664;</div><div class="cb" id="p1r">&#9654;</div></div></div>
</div>
<script>
(function(){
function save(k,v){try{localStorage.setItem('pp_'+k,JSON.stringify(v))}catch(e){}}
function load(k,d){try{var v=localStorage.getItem('pp_'+k);return v?JSON.parse(v):d}catch(e){return d}}
var userData=load('user',null),settings=load('settings',{musicVol:40,sfxVol:60,particles:true,vibration:true}),admPass=load('admPass','pong2024');
function api(m,p,b,cb){var x=new XMLHttpRequest();x.open(m,p,true);x.setRequestHeader('Content-Type','application/json');x.onload=function(){try{cb(null,JSON.parse(x.responseText))}catch(e){cb(e)}};x.onerror=function(){cb(new Error('err'))};x.send(b?JSON.stringify(b):null)}
function submitScore(pts,cb){if(!userData||pts<=0)return cb&&cb();api('POST','/api/score',{name:userData.name,points:pts},function(e,r){cb&&cb(r&&r.rank?r.rank:null)})}
function loadMyRank(){if(!userData)return;api('GET','/api/player/'+encodeURIComponent(userData.name),null,function(e,r){if(!e&&r&&r.found)document.getElementById('menuRank').innerHTML='Ранг: <b>#'+r.rank+'</b> | Очки: <b>'+r.player.totalPts+'</b>';else document.getElementById('menuRank').textContent=''})}
var actx=null,musicGain,sfxGain,musicNodes=[],musicStarted=false,musicTimer=null;
function initAudio(){if(actx)return;try{actx=new(window.AudioContext||window.webkitAudioContext)();musicGain=actx.createGain();musicGain.gain.value=settings.musicVol/100*.25;musicGain.connect(actx.destination);sfxGain=actx.createGain();sfxGain.gain.value=settings.sfxVol/100;sfxGain.connect(actx.destination)}catch(e){}}
function startMusic(){if(!actx||musicStarted)return;musicStarted=true;var melody=[493.88,.18,739.99,.18,987.77,.18,932.33,.09,987.77,.09,739.99,.18,587.33,.18,493.88,.18,739.99,.18,987.77,.18,932.33,.09,987.77,.09,1108.73,.18,1174.66,.18,1108.73,.09,987.77,.09,932.33,.09,987.77,.09,739.99,.18,587.33,.18,493.88,.36,587.33,.18,659.26,.18,739.99,.18,659.26,.09,587.33,.09,493.88,.18,587.33,.18,493.88,.18,440,.18,493.88,.36,0,.18,493.88,.18,739.99,.18,987.77,.18,932.33,.09,987.77,.09,739.99,.18,587.33,.18,493.88,.18,659.26,.18,739.99,.18,587.33,.09,659.26,.09,493.88,.18,587.33,.18,493.88,.09,440,.09,369.99,.18,440,.18,493.88,.36,0,.36];var bpm=140,bl=60/bpm;function pl(){if(!musicStarted)return;var t=actx.currentTime+.05;for(var i=0;i<melody.length;i+=2){var f=melody[i],d=melody[i+1]*bl*2;if(f>0){var o=actx.createOscillator();o.type='triangle';o.frequency.value=f;var g=actx.createGain();g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(.07,t+.02);g.gain.setValueAtTime(.07,t+d*.7);g.gain.linearRampToValueAtTime(0,t+d*.95);var fl=actx.createBiquadFilter();fl.type='lowpass';fl.frequency.value=2500;o.connect(fl);fl.connect(g);g.connect(musicGain);o.start(t);o.stop(t+d);var o2=actx.createOscillator();o2.type='sine';o2.frequency.value=f/2;var g2=actx.createGain();g2.gain.setValueAtTime(0,t);g2.gain.linearRampToValueAtTime(.03,t+.02);g2.gain.setValueAtTime(.03,t+d*.7);g2.gain.linearRampToValueAtTime(0,t+d*.95);o2.connect(g2);g2.connect(musicGain);o2.start(t);o2.stop(t+d)}t+=d}musicTimer=setTimeout(pl,(t-actx.currentTime)*1000-100)}var bo=actx.createOscillator();bo.type='sine';bo.frequency.value=61.74;var bg=actx.createGain();bg.gain.value=.06;var bf=actx.createBiquadFilter();bf.type='lowpass';bf.frequency.value=120;bo.connect(bf);bf.connect(bg);bg.connect(musicGain);bo.start();musicNodes.push(bo);pl()}
function stopMusic(){musicStarted=false;clearTimeout(musicTimer);musicNodes.forEach(function(n){try{n.stop()}catch(e){}});musicNodes=[]}
function sfx(f,tp,d,v){if(!actx||settings.sfxVol<=0)return;var o=actx.createOscillator();o.type=tp||'square';o.frequency.value=f;var g=actx.createGain();var t=actx.currentTime;g.gain.setValueAtTime((v||.1)*settings.sfxVol/100,t);g.gain.exponentialRampToValueAtTime(.001,t+(d||.1));o.connect(g);g.connect(sfxGain);o.start(t);o.stop(t+(d||.1)+.02)}
function playHit(f){sfx(f,'square',.08,.12)}function playWall(){sfx(220,'triangle',.05,.05)}
function playScore(w){var fs=w?[523,659,784]:[330,262,196];fs.forEach(function(f,i){setTimeout(function(){sfx(f,'sine',.2,.1)},i*100)})}
function playGO(w){var fs=w?[523,659,784,1047]:[440,349,294,220];fs.forEach(function(f,i){setTimeout(function(){sfx(f,w?'sine':'sawtooth',.35,.1)},i*170)})}
function vib(ms){if(settings.vibration&&navigator.vibrate)navigator.vibrate(ms)}
var screens=document.querySelectorAll('.screen');
function showScreen(id){screens.forEach(function(s){s.classList.remove('active');s.classList.add('hide')});document.getElementById(id).classList.remove('hide');document.getElementById(id).classList.add('active');if(id==='menuScreen')loadMyRank()}
document.querySelectorAll('.back').forEach(function(b){if(b.dataset.to)b.addEventListener('click',function(){showScreen(b.dataset.to)})});
if(userData){showScreen('menuScreen');document.getElementById('menuNick').textContent=userData.name}
document.getElementById('nickBtn').addEventListener('click',function(){var n=document.getElementById('nickIn').value.trim();if(!n)return;userData={name:n};save('user',userData);document.getElementById('menuNick').textContent=n;showScreen('menuScreen')});
var tapC=0,tapTm;document.querySelector('.m-logo').addEventListener('click',function(){tapC++;clearTimeout(tapTm);tapTm=setTimeout(function(){tapC=0},600);if(tapC>=5){tapC=0;document.getElementById('mcAdm').style.display='block'}});
document.getElementById('mcAdm').addEventListener('click',function(){var p=prompt('Пароль:');if(p){admPass=p;save('admPass',p);showScreen('adminScreen');loadAdmStats()}});
function loadAdmStats(){api('GET','/api/stats',null,function(e,r){if(!e&&r)document.getElementById('admStats').innerHTML='Игроков: '+r.totalPlayers+'<br>Игр: '+r.totalGames+'<br>Очков: '+r.totalPoints})}
document.getElementById('admClearLb').addEventListener('click',function(){if(!confirm('Очистить?'))return;api('POST','/api/admin/clear',{pass:admPass},function(e,r){alert(r&&r.ok?'Готово':'Ошибка');loadAdmStats()})});
document.getElementById('admDelBtn').addEventListener('click',function(){var n=document.getElementById('admDelName').value.trim();if(!n)return;api('POST','/api/admin/delete-player',{pass:admPass,name:n},function(e,r){alert(r&&r.ok?'Удалён':'Ошибка')})});
document.getElementById('admAddBtn').addEventListener('click',function(){var n=document.getElementById('admAddName').value.trim(),p=parseInt(document.getElementById('admAddPts').value)||0;if(!n)return;api('POST','/api/admin/add-points',{pass:admPass,name:n,points:p},function(e,r){alert(r&&r.ok?'Добавлено':'Ошибка')})});
document.getElementById('admPassBtn').addEventListener('click',function(){var np=document.getElementById('admNewPass').value.trim();if(!np)return;api('POST','/api/admin/change-pass',{oldPass:admPass,newPass:np},function(e,r){if(r&&r.ok){admPass=np;save('admPass',np);alert('Сменён')}else alert('Ошибка')})});
document.getElementById('mcSet').addEventListener('click',function(){document.getElementById('sMusVol').value=settings.musicVol;document.getElementById('sSfxVol').value=settings.sfxVol;document.getElementById('sPartT').classList.toggle('on',settings.particles);document.getElementById('sVibT').classList.toggle('on',settings.vibration);showScreen('settingsScreen')});
document.getElementById('sMusVol').addEventListener('input',function(){settings.musicVol=+this.value;if(musicGain)musicGain.gain.value=settings.musicVol/100*.25;save('settings',settings)});
document.getElementById('sSfxVol').addEventListener('input',function(){settings.sfxVol=+this.value;if(sfxGain)sfxGain.gain.value=settings.sfxVol/100;save('settings',settings)});
document.getElementById('sPartT').addEventListener('click',function(){settings.particles=!settings.particles;this.classList.toggle('on',settings.particles);save('settings',settings)});
document.getElementById('sVibT').addEventListener('click',function(){settings.vibration=!settings.vibration;this.classList.toggle('on',settings.vibration);save('settings',settings)});
document.getElementById('sReset').addEventListener('click',function(){if(confirm('Удалить?')){localStorage.clear();location.reload()}});
document.getElementById('pMus').addEventListener('input',function(){settings.musicVol=+this.value;if(musicGain)musicGain.gain.value=settings.musicVol/100*.25;save('settings',settings)});
document.getElementById('pSfx').addEventListener('input',function(){settings.sfxVol=+this.value;if(sfxGain)sfxGain.gain.value=settings.sfxVol/100;save('settings',settings)});
var lbData=[],lbSort='totalPts';
document.getElementById('mcLb').addEventListener('click',function(){showScreen('lbScreen');loadLb()});
document.querySelectorAll('.lb-tab').forEach(function(t){t.addEventListener('click',function(){document.querySelectorAll('.lb-tab').forEach(function(x){x.classList.remove('on')});t.classList.add('on');lbSort=t.dataset.sort;renderLb()})});
function loadLb(){document.getElementById('lbList').innerHTML='<div class="lb-empty">Загрузка...</div>';api('GET','/api/leaderboard',null,function(e,d){if(e||!d){document.getElementById('lbList').innerHTML='<div class="lb-empty">Ошибка</div>';return}lbData=d;renderLb()});api('GET','/api/stats',null,function(e,d){if(!e&&d)document.getElementById('lbStats').innerHTML='<div class="lb-stat"><div class="lsv">'+d.totalPlayers+'</div><div class="lsl">Игроков</div></div><div class="lb-stat"><div class="lsv">'+d.totalGames+'</div><div class="lsl">Игр</div></div><div class="lb-stat"><div class="lsv">'+d.totalPoints+'</div><div class="lsl">Очков</div></div>'});if(userData)api('GET','/api/player/'+encodeURIComponent(userData.name),null,function(e,r){var el=document.getElementById('lbMe');if(!e&&r&&r.found){el.style.display='flex';el.innerHTML='<div class="lb-me-rank">#'+r.rank+'<span>ранг</span></div><div class="lb-me-info"><div class="lb-me-name">'+r.player.name+'</div><div class="lb-me-stats">Очки:'+r.player.totalPts+' Игр:'+r.player.games+' Лучшая:'+r.player.bestGame+'</div></div>'}else el.style.display='none'})}
function renderLb(){if(!lbData.length){document.getElementById('lbList').innerHTML='<div class="lb-empty">Пока пусто!</div>';return}var sorted=lbData.slice().sort(function(a,b){return(b[lbSort]||0)-(a[lbSort]||0)});var h='';sorted.forEach(function(p,i){var rc=i===0?'g':i===1?'s':i===2?'b':'';var isMe=userData&&p.name.toLowerCase()===userData.name.toLowerCase();var val=lbSort==='totalPts'?p.totalPts:lbSort==='bestGame'?p.bestGame:p.games;h+='<div class="lb-item'+(isMe?' me':'')+'"><div class="lb-rank '+rc+'">'+(i+1)+'</div><div class="lb-info"><div class="lb-name">'+(isMe?'* ':'')+p.name+'</div><div class="lb-sub">Очки:'+p.totalPts+' Игр:'+p.games+'</div></div><div class="lb-right"><div class="lb-pts">'+val+'</div></div></div>'});document.getElementById('lbList').innerHTML=h}

/* ===== ONLINE INTERPOLATION & PING ===== */
var ws=null,wsReady=false,isOnline=false,myRole='host',mmTimer=null;
var netP2x=.5,netBallX=.5,netBallY=.5,netBallVX=0,netBallVY=0;
var dispP2x=.5,dispBallX=.5,dispBallY=.5;
var lastBallUpdate=0,pingStart=0;

function connectWS(){if(ws&&ws.readyState<=1)return;var proto=location.protocol==='https:'?'wss:':'ws:';try{ws=new WebSocket(proto+'//'+location.host);ws.onopen=function(){wsReady=true;updConn();startPing()};ws.onclose=function(){wsReady=false;updConn();setTimeout(connectWS,3000)};ws.onerror=function(){wsReady=false;updConn()};ws.onmessage=function(e){var m;try{m=JSON.parse(e.data)}catch(x){return}handleWS(m)}}catch(e){wsReady=false;updConn()}}
function updConn(){var d=document.getElementById('connDot'),t=document.getElementById('connTxt');if(d){if(wsReady){d.className='conn-dot conn-on';t.textContent='Подключено'}else{d.className='conn-dot conn-off';t.textContent='Нет соединения'}}}
function wsSend(o){if(ws&&ws.readyState===1)ws.send(JSON.stringify(o))}
function startPing(){setInterval(function(){if(wsReady){pingStart=Date.now();wsSend({type:'ping',t:pingStart})}},1000)}

function handleWS(m){switch(m.type){
case'created':document.getElementById('lobbyCodeTxt').textContent=m.code;showScreen('lobbyCreate');break;
case'error':document.getElementById('joinErr').textContent=m.text;break;
case'start':myRole=m.role;gameMode='online';gameType='points';winPts=10;isOnline=true;clearInterval(mmTimer);showScreen('gameScreen');document.getElementById('gGear').style.display='none';document.getElementById('pingDisp').style.display='block';setTimeout(function(){resize();initGame();document.getElementById('lb1').textContent=myRole==='host'?'Ты':m.enemy;document.getElementById('lb2').textContent=myRole==='host'?m.enemy:'Ты';draw();running=true;paused=false;countdown(function(){startMusic();loop()})},100);break;
case'move':netP2x=m.x;break;
case'ball':if(myRole==='guest'){netBallX=m.x;netBallY=1-m.y;netBallVX=m.vx;netBallVY=-m.vy;lastBallUpdate=performance.now()}break;
case'scored':if(isOnline&&myRole==='guest'){sc1=m.s2;sc2=m.s1;document.getElementById('s1').textContent=sc1;document.getElementById('s2').textContent=sc2}break;
case'gameover':if(isOnline){var iw=(myRole==='host'&&m.winner==='host')||(myRole==='guest'&&m.winner==='guest');endGameShow(iw,myRole==='guest'?m.s2:m.s1,myRole==='guest'?m.s1:m.s2)}break;
case'left':running=false;alert('Соперник вышел');quitToMenu();break;
case'queue_size':document.getElementById('mmCount').textContent='В очереди: '+m.count;break;
case'pong':var p=Date.now()-m.t;document.getElementById('pingDisp').textContent='PING: '+p;break;
}}

document.getElementById('mcOnline').addEventListener('click',function(){showScreen('onlineMenu');connectWS()});
document.getElementById('olCreate').addEventListener('click',function(){if(!wsReady)return alert('Нет соединения');wsSend({type:'create',name:userData?userData.name:'?'})});
document.getElementById('olJoin').addEventListener('click',function(){showScreen('lobbyJoin');document.getElementById('joinErr').textContent=''});
document.getElementById('joinBtn').addEventListener('click',function(){var c=document.getElementById('joinIn').value.trim().toUpperCase();if(c.length<3){document.getElementById('joinErr').textContent='Введи код';return}if(!wsReady){document.getElementById('joinErr').textContent='Нет соединения';return}wsSend({type:'join',code:c,name:userData?userData.name:'?'})});
document.getElementById('lobbyCancel1').addEventListener('click',function(){wsSend({type:'leave'});showScreen('onlineMenu')});
document.getElementById('lobbyCancel2').addEventListener('click',function(){showScreen('onlineMenu')});
document.getElementById('olMatch').addEventListener('click',function(){if(!wsReady)return alert('Нет соединения');wsSend({type:'matchmake',name:userData?userData.name:'?'});showScreen('matchmaking');document.getElementById('mmStatus').textContent='Ищем игрока...';document.getElementById('mmCount').textContent='';mmTimer=setInterval(function(){wsSend({type:'queue_check'})},2000)});
document.getElementById('mmCancel').addEventListener('click',function(){clearInterval(mmTimer);wsSend({type:'leave_queue'});showScreen('onlineMenu')});

document.getElementById('mcBot').addEventListener('click',function(){showScreen('botMenu')});
document.getElementById('mcTwo').addEventListener('click',function(){showScreen('twoMenu')});
var gameMode='ai',gameType='points',diff='medium',winPts=10;
// EASY BOT IS NOW HARDER (Speed .42, React .55)
var DS={easy:{aiSpd:.42,aiReact:.55,ballSpd:.008,acc:.0004},medium:{aiSpd:.55,aiReact:.65,ballSpd:.011,acc:.0006},hard:{aiSpd:.75,aiReact:.88,ballSpd:.014,acc:.0008}};
document.querySelectorAll('#diffRow .db').forEach(function(b){b.addEventListener('click',function(){document.querySelectorAll('#diffRow .db').forEach(function(x){x.classList.remove('on')});b.classList.add('on');diff=b.dataset.v})});
document.getElementById('mInf').addEventListener('click',function(){gameMode='ai';gameType='infinite';winPts=99999;isOnline=false;launchGame()});
document.getElementById('mPts').addEventListener('click',function(){showScreen('ptsMenu')});
document.querySelectorAll('#ptsMenu .pb').forEach(function(b){b.addEventListener('click',function(){gameMode='ai';gameType='points';winPts=+b.dataset.p;isOnline=false;launchGame()})});
document.querySelectorAll('#twoPg .pb').forEach(function(b){b.addEventListener('click',function(){gameMode='2p';gameType='points';winPts=+b.dataset.p;isOnline=false;launchGame()})});

var cn=document.getElementById('c'),ctx=cn.getContext('2d'),gMid=document.getElementById('gMid'),dpr=Math.min(window.devicePixelRatio||1,2);
function resize(){var r=gMid.getBoundingClientRect();cn.width=r.width*dpr;cn.height=r.height*dpr}
var W=function(){return cn.width},H=function(){return cn.height};
var PW=.18,PH=.022,BR=.014,PM=.06,p1,p2,ball,sc1,sc2,running=false,paused=false,particles=[],trails=[],ballSlow=0,gridPhase=0;

function initGame(){resize();var d=DS[diff]||DS.medium;p1={x:.5-PW/2,y:1-PM-PH,w:PW,h:PH,spd:.012};p2={x:.5-PW/2,y:PM,w:PW,h:PH,spd:(d.aiSpd||.55)*.012/.55};sc1=0;sc2=0;netP2x=.5-PW/2;dispP2x=.5-PW/2;netBallX=.5;netBallY=.5;netBallVX=0;netBallVY=0;dispBallX=.5;dispBallY=.5;document.getElementById('s1').textContent='0';document.getElementById('s2').textContent='0';particles=[];trails=[];gridPhase=0;if(gameMode==='2p'){document.getElementById('lb1').textContent='Игрок 1';document.getElementById('lb2').textContent='Игрок 2'}else if(gameMode==='ai'){document.getElementById('lb1').textContent='Игрок';document.getElementById('lb2').textContent='Бот'}resetBall(1)}
function resetBall(dir){var d=DS[diff]||DS.medium;var ang=(Math.random()*.6+.2)*(Math.random()>.5?1:-1);ball={x:.5,y:.5,vx:Math.sin(ang)*d.ballSpd,vy:dir*Math.cos(ang)*d.ballSpd,spd:d.ballSpd,r:BR};ballSlow=70;dispBallX=.5;dispBallY=.5}

var inp={p1l:false,p1r:false,p2l:false,p2r:false};
document.addEventListener('keydown',function(e){if(e.key==='ArrowLeft')inp.p1l=true;if(e.key==='ArrowRight')inp.p1r=true;if(e.key==='a'||e.key==='A')inp.p2l=true;if(e.key==='d'||e.key==='D')inp.p2r=true;if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].indexOf(e.key)!==-1)e.preventDefault()});
document.addEventListener('keyup',function(e){if(e.key==='ArrowLeft')inp.p1l=false;if(e.key==='ArrowRight')inp.p1r=false;if(e.key==='a'||e.key==='A')inp.p2l=false;if(e.key==='d'||e.key==='D')inp.p2r=false});
function tb(id,key){var el=document.getElementById(id);if(!el)return;el.addEventListener('touchstart',function(e){e.preventDefault();inp[key]=true},{passive:false});el.addEventListener('touchend',function(e){e.preventDefault();inp[key]=false},{passive:false});el.addEventListener('touchcancel',function(){inp[key]=false});el.addEventListener('mousedown',function(){inp[key]=true});el.addEventListener('mouseup',function(){inp[key]=false});el.addEventListener('mouseleave',function(){inp[key]=false})}
tb('p1l','p1l');tb('p1r','p1r');tb('p2l','p2l');tb('p2r','p2r');
document.body.addEventListener('touchmove',function(e){e.preventDefault()},{passive:false});
function addP(px,py,col,n){if(!settings.particles)return;for(var i=0;i<n;i++)particles.push({x:px,y:py,vx:(Math.random()-.5)*.025,vy:(Math.random()-.5)*.025,life:1,dec:.02+Math.random()*.03,sz:.004+Math.random()*.009,col:col})}

var syncT=0;
function update(){
var d=DS[diff]||DS.medium;
var sm=1;if(ballSlow>0){sm=.3+.7*(1-ballSlow/70);ballSlow--}
if(inp.p1l)p1.x-=p1.spd;if(inp.p1r)p1.x+=p1.spd;
p1.x=Math.max(0,Math.min(1-p1.w,p1.x));

if(isOnline){
  syncT++;
  if(syncT%2===0)wsSend({type:'move',x:p1.x});
  // Smooth opponent with simple lerp (less jitter)
  dispP2x+=(netP2x-dispP2x)*0.2;
  p2.x=dispP2x;
  // Guest smooth ball
  if(myRole==='guest'){
    // Calculate predicted position based on velocity
    var timePassed=(performance.now()-lastBallUpdate)/1000;
    // Limit prediction to avoid overshooting too much
    if(timePassed>0.5)timePassed=0.5; 
    var predX=netBallX+netBallVX*timePassed*60;
    var predY=netBallY+netBallVY*timePassed*60;
    // Smooth transition to predicted position
    dispBallX+=(predX-dispBallX)*0.2;
    dispBallY+=(predY-dispBallY)*0.2;
    ball.x=dispBallX; ball.y=dispBallY;
  }
}else if(gameMode==='ai'){
  if(ball.vy<0&&Math.random()<d.aiReact){var tg=ball.x-p2.w/2;var df=tg-p2.x;if(Math.abs(df)>.005)p2.x+=Math.sign(df)*Math.min(Math.abs(df),p2.spd)}
  else if(ball.vy>=0){var ct=.5-p2.w/2;var d2=ct-p2.x;if(Math.abs(d2)>.005)p2.x+=Math.sign(d2)*Math.min(Math.abs(d2),p2.spd*.3)}
}else if(gameMode==='2p'){
  if(inp.p2l)p2.x-=p2.spd;if(inp.p2r)p2.x+=p2.spd;
}
p2.x=Math.max(0,Math.min(1-p2.w,p2.x));

if(!isOnline||myRole==='host'){
  ball.x+=ball.vx*sm;ball.y+=ball.vy*sm;
  if(ball.x-ball.r<0){ball.x=ball.r;ball.vx=Math.abs(ball.vx);addP(ball.x,ball.y,'#00e5ff',5);playWall()}
  if(ball.x+ball.r>1){ball.x=1-ball.r;ball.vx=-Math.abs(ball.vx);addP(ball.x,ball.y,'#00e5ff',5);playWall()}
  if(ball.vy>0&&ball.y+ball.r>=p1.y&&ball.y+ball.r<=p1.y+p1.h+.01&&ball.x>=p1.x-.01&&ball.x<=p1.x+p1.w+.01){var h=(ball.x-(p1.x+p1.w/2))/(p1.w/2);var a=h*1.05;ball.spd+=d.acc;if(ball.spd>.025)ball.spd=.025;ball.vx=Math.sin(a)*ball.spd;ball.vy=-Math.cos(a)*ball.spd;ball.y=p1.y-ball.r;addP(ball.x,ball.y,'#00e5ff',10);playHit(660);vib(15)}
  if(ball.vy<0&&ball.y-ball.r<=p2.y+p2.h&&ball.y-ball.r>=p2.y-.01&&ball.x>=p2.x-.01&&ball.x<=p2.x+p2.w+.01){var h2=(ball.x-(p2.x+p2.w/2))/(p2.w/2);var a2=h2*1.05;ball.spd+=d.acc;if(ball.spd>.025)ball.spd=.025;ball.vx=Math.sin(a2)*ball.spd;ball.vy=Math.cos(a2)*ball.spd;ball.y=p2.y+p2.h+ball.r;addP(ball.x,ball.y,'#ff1744',10);playHit(440);vib(15)}
  if(ball.y>1.05){sc2++;document.getElementById('s2').textContent=sc2;addP(ball.x,1,'#ff1744',15);playScore(false);vib(40);if(isOnline)wsSend({type:'scored',s1:sc1,s2:sc2});if(gameType==='points'&&sc2>=winPts){if(isOnline)wsSend({type:'gameover',winner:myRole==='host'?'guest':'host',s1:sc1,s2:sc2});endGame();return}resetBall(-1)}
  if(ball.y<-.05){sc1++;document.getElementById('s1').textContent=sc1;addP(ball.x,0,'#00e5ff',15);playScore(true);vib(40);if(isOnline)wsSend({type:'scored',s1:sc1,s2:sc2});if(gameType==='points'&&sc1>=winPts){if(isOnline)wsSend({type:'gameover',winner:myRole,s1:sc1,s2:sc2});endGame();return}resetBall(1)}
  if(isOnline&&syncT%3===0)wsSend({type:'ball',x:ball.x,y:ball.y,vx:ball.vx,vy:ball.vy});
}

if(settings.particles){trails.push({x:ball.x,y:ball.y,life:1});if(trails.length>25)trails.shift()}
for(var i=particles.length-1;i>=0;i--){var p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vx*=.94;p.vy*=.94;p.life-=p.dec;if(p.life<=0)particles.splice(i,1)}
for(var i=trails.length-1;i>=0;i--){trails[i].life-=.055;if(trails[i].life<=0)trails.splice(i,1)}
gridPhase+=.003}

function draw(){var w=W(),h=H();ctx.clearRect(0,0,w,h);var bg=ctx.createRadialGradient(w/2,h/2,0,w/2,h/2,Math.max(w,h)*.7);bg.addColorStop(0,'#0a0a2a');bg.addColorStop(.5,'#060618');bg.addColorStop(1,'#020210');ctx.fillStyle=bg;ctx.fillRect(0,0,w,h);ctx.strokeStyle='rgba(0,229,255,.04)';ctx.lineWidth=1;var gs=w/12,gy=(gridPhase*100)%gs;for(var i=-1;i<14;i++){ctx.beginPath();ctx.moveTo(i*gs,0);ctx.lineTo(i*gs,h);ctx.stroke()}for(var i=-1;i<20;i++){ctx.beginPath();ctx.moveTo(0,i*gs+gy);ctx.lineTo(w,i*gs+gy);ctx.stroke()}ctx.save();ctx.shadowColor='#00e5ff';ctx.shadowBlur=30*dpr;ctx.strokeStyle='rgba(0,229,255,.12)';ctx.lineWidth=2;ctx.strokeRect(4,4,w-8,h-8);ctx.restore();ctx.save();ctx.shadowColor='#7c4dff';ctx.shadowBlur=15*dpr;ctx.setLineDash([w*.015,w*.025]);ctx.strokeStyle='rgba(124,77,255,.2)';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,h/2);ctx.lineTo(w,h/2);ctx.stroke();ctx.setLineDash([]);ctx.restore();ctx.save();ctx.shadowColor='#7c4dff';ctx.shadowBlur=20*dpr;ctx.strokeStyle='rgba(124,77,255,.12)';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(w/2,h/2,w*.1,0,Math.PI*2);ctx.stroke();ctx.restore();var cl=w*.06;ctx.strokeStyle='rgba(0,229,255,.15)';ctx.lineWidth=2;[[0,0,1,1],[w,0,-1,1],[0,h,1,-1],[w,h,-1,-1]].forEach(function(c){ctx.beginPath();ctx.moveTo(c[0],c[1]+c[3]*cl);ctx.lineTo(c[0],c[1]);ctx.lineTo(c[0]+c[2]*cl,c[1]);ctx.stroke()});ctx.globalAlpha=.03;ctx.fillStyle='#00e5ff';ctx.font='bold '+Math.floor(h*.14)+'px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(sc1,w/2,h*.72);ctx.fillText(sc2,w/2,h*.28);ctx.globalAlpha=1;ctx.textBaseline='alphabetic';
if(settings.particles){for(var i=0;i<trails.length;i++){var t=trails[i];ctx.globalAlpha=t.life*.25;ctx.save();ctx.shadowColor='#00e5ff';ctx.shadowBlur=8*dpr;ctx.fillStyle='#00e5ff';ctx.beginPath();ctx.arc(t.x*w,t.y*h,ball.r*w*t.life*.6,0,Math.PI*2);ctx.fill();ctx.restore()}ctx.globalAlpha=1;for(var i=0;i<particles.length;i++){var p=particles[i];ctx.globalAlpha=p.life;ctx.fillStyle=p.col;ctx.beginPath();ctx.arc(p.x*w,p.y*h,p.sz*w*p.life,0,Math.PI*2);ctx.fill()}ctx.globalAlpha=1}
ctx.save();ctx.shadowColor='#00e5ff';ctx.shadowBlur=25*dpr;var g1=ctx.createLinearGradient(p1.x*w,0,(p1.x+p1.w)*w,0);g1.addColorStop(0,'rgba(0,180,255,.1)');g1.addColorStop(.3,'#00e5ff');g1.addColorStop(.5,'#80f0ff');g1.addColorStop(.7,'#00e5ff');g1.addColorStop(1,'rgba(0,180,255,.1)');ctx.fillStyle=g1;rr(ctx,p1.x*w,p1.y*h,p1.w*w,p1.h*h,p1.h*h/2);ctx.fill();ctx.restore();
ctx.save();ctx.shadowColor='#ff1744';ctx.shadowBlur=25*dpr;var g2=ctx.createLinearGradient(p2.x*w,0,(p2.x+p2.w)*w,0);g2.addColorStop(0,'rgba(255,23,68,.1)');g2.addColorStop(.3,'#ff1744');g2.addColorStop(.5,'#ff6680');g2.addColorStop(.7,'#ff1744');g2.addColorStop(1,'rgba(255,23,68,.1)');ctx.fillStyle=g2;rr(ctx,p2.x*w,p2.y*h,p2.w*w,p2.h*h,p2.h*h/2);ctx.fill();ctx.restore();
ctx.save();ctx.shadowColor='#00e5ff';ctx.shadowBlur=35*dpr;var gb=ctx.createRadialGradient(ball.x*w,ball.y*h,0,ball.x*w,ball.y*h,ball.r*w*1.2);gb.addColorStop(0,'#fff');gb.addColorStop(.2,'#e0f7fa');gb.addColorStop(.5,'#00e5ff');gb.addColorStop(.8,'#0088aa');gb.addColorStop(1,'rgba(0,136,170,0)');ctx.fillStyle=gb;ctx.beginPath();ctx.arc(ball.x*w,ball.y*h,ball.r*w*1.2,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(ball.x*w,ball.y*h,ball.r*w*.4,0,Math.PI*2);ctx.fill();ctx.restore()}
function rr(c,x,y,w2,h2,r){c.beginPath();c.moveTo(x+r,y);c.lineTo(x+w2-r,y);c.quadraticCurveTo(x+w2,y,x+w2,y+r);c.lineTo(x+w2,y+h2-r);c.quadraticCurveTo(x+w2,y+h2,x+w2-r,y+h2);c.lineTo(x+r,y+h2);c.quadraticCurveTo(x,y+h2,x,y+h2-r);c.lineTo(x,y+r);c.quadraticCurveTo(x,y,x+r,y);c.closePath()}
function loop(){if(!running||paused)return;update();draw();requestAnimationFrame(loop)}
function countdown(cb){var co=document.getElementById('cdOv'),cn2=document.getElementById('cdN');co.classList.remove('hide');var c=3;cn2.textContent=c;sfx(440,'sine',.08,.08);var iv=setInterval(function(){c--;if(c>0){cn2.textContent=c;sfx(440,'sine',.08,.08)}else if(c===0){cn2.textContent='GO!';sfx(880,'sine',.15,.1)}else{clearInterval(iv);co.classList.add('hide');cb()}},800)}
function endGameShow(won,mySc,opSc){running=false;document.getElementById('goS1').textContent=mySc;document.getElementById('goS2').textContent=opSc;document.getElementById('goT').textContent=won?'Победа!':'Поражение!';document.getElementById('goT').style.color=won?'var(--cyan)':'var(--red)';document.getElementById('goE').textContent=won?'&#127942;':':(';if(isOnline)document.getElementById('goRe').style.display='none';else document.getElementById('goRe').style.display='';document.getElementById('goOv').classList.remove('hide');playGO(won);vib(won?[30,50,30]:[100]);submitScore(mySc,function(rank){if(rank)document.getElementById('goRank').innerHTML='Ранг: <b>#'+rank+'</b>';else document.getElementById('goRank').textContent=''})}
function endGame(){var won=sc1>=winPts;if(gameMode==='2p')document.getElementById('goT').textContent=won?'Игрок 1!':'Игрок 2!';endGameShow(won,sc1,sc2)}
function quitToMenu(){running=false;paused=false;stopMusic();if(isOnline)wsSend({type:'leave'});isOnline=false;if(gameType==='infinite'&&sc1>0)submitScore(sc1,function(){});document.getElementById('pOv').classList.add('hide');document.getElementById('goOv').classList.add('hide');document.getElementById('cdOv').classList.add('hide');showScreen('menuScreen')}
function launchGame(){initAudio();showScreen('gameScreen');document.getElementById('p2top').style.display=gameMode==='2p'?'block':'none';document.getElementById('gGear').style.display=isOnline?'none':'flex';document.getElementById('pingDisp').style.display=isOnline?'block':'none';setTimeout(function(){resize();initGame();draw();document.getElementById('pMus').value=settings.musicVol;document.getElementById('pSfx').value=settings.sfxVol;paused=false;running=true;countdown(function(){startMusic();loop()})},100)}
document.getElementById('gGear').addEventListener('click',function(){if(!running||isOnline)return;paused=true;document.getElementById('pOv').classList.remove('hide')});
document.getElementById('pResume').addEventListener('click',function(){document.getElementById('pOv').classList.add('hide');countdown(function(){paused=false;loop()})});
document.getElementById('pQuit').addEventListener('click',quitToMenu);
document.getElementById('goRe').addEventListener('click',function(){document.getElementById('goOv').classList.add('hide');stopMusic();initGame();draw();paused=false;running=true;countdown(function(){startMusic();loop()})});
document.getElementById('goMn').addEventListener('click',quitToMenu);
document.addEventListener('dblclick',function(e){e.preventDefault()});
window.addEventListener('resize',function(){if(running)resize()});
})();
</script>
</body>
</html>
